dependencies:
  pre:
    - mkdir -p `pwd`/build
    - curl -sSL https://get.rvm.io | bash -s stable --ruby
    - sudo gem install bundler
    - bundle install
    - git clone https://github.com/nomad/cupertino
    - sudo gem install cupertino
    - sudo ios profiles:download "$DEV_PROVIOSNING_PROFILE" -u "$APPLE_USER" -p "$APPLE_PASS"
    - security import devpro.p12 -k ~/Library/Keychains/login.keychain -P $DIMITAR_CSI_PASS -T /usr/bin/codesign -A
    - security find-identity -v -p codesigning
    - rm -Rf ~/Library/MobileDevice/Provisioning\ Profiles/*
    - cp *.mobileprovision  ~/Library/MobileDevice/Provisioning\ Profiles/$EXPANDED_CODE_SIGNING_IDENTITY.mobileprovision 
test:
  override:
    - xctool
      -reporter pretty
      -reporter junit:$CIRCLE_TEST_REPORTS/xcode/results.xml
      -reporter plain:$CIRCLE_ARTIFACTS/xctool.log
      BUILD_DIR="`pwd`/build"
      BUILD_ROOT="`pwd`/build"
      CODE_SIGNING_ALLOWED=YES
      CODE_SIGNING_REQUIRED=YES
      XCODE_SCHEME="$SCHEME_XCODE"
      EXPANDED_CODE_SIGN_IDENTITY="$EXPANDED_CODE_SIGNING_IDENTITY"
      CODE_SIGN_IDENTITY="$CODE_SINING_IDENTITY"
      PROVISIONING_PROFILE="$PROVISIONING_PROFILE_UUID"
      -workspace "$WORKSPACE_XCODE"
      -scheme $SCHEME_XCODE
      build
deployment:
  testflight:
    branch: submission
    commands:
      - xcrun -sdk iphoneos PackageApplication -v `pwd`/build/Debug-iphoneos/RefIOS.app   -o `pwd`/build/Tumbaios.ipa --sign $CODE_SINING_IDENTITY --embed="devpro.p12"
